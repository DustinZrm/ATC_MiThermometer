name: Build and Publish Release

# 触发条件：推送以 v 开头的标签（如 v1.0.0、v1.1.2）
on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # -------------------------- 1. 拉取代码 --------------------------
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整历史，确保 tag 信息正确

      # -------------------------- 2. 安装依赖（可选） --------------------------
      # 若项目需要交叉编译器/工具链（如 ARM GCC），在此安装
      - name: Install Build Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            arm-none-eabi-gcc  # 示例：ARM 交叉编译器
          # 若项目有其他依赖（如 Python 库），可添加：
          # pip install --user -r requirements.txt

      # -------------------------- 3. 执行 make 编译 --------------------------
      - name: Build Project with Make
        run: make
        # 若项目在子文件夹（如 ./src），调整为：
        # run: make -C ./src

      # -------------------------- 4. 验证 bin 文件存在 --------------------------
      - name: Verify Bin File
        id: verify_bin
        run: |
          if [[ ! -f "ATC_Thermometer.bin" ]]; then
            echo "::error::ATC_Thermometer.bin not found in root directory!"
            exit 1
          fi
          echo "✅ Bin file found: $(pwd)/ATC_Thermometer.bin"
          # 传递 bin 文件名给后续步骤
          echo "bin_name=ATC_Thermometer.bin" >> $GITHUB_OUTPUT

      # -------------------------- 5. 创建 GitHub Release --------------------------
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 自动注入的 token，无需手动配置
        with:
          tag_name: ${{ github.ref_name }}  # 使用触发 workflow 的 tag 名称
          release_name: Release ${{ github.ref_name }}  # Release 标题（如 Release v1.0.0）
          draft: false  # 是否为草稿（false 表示直接发布）
          prerelease: false  # 是否为预发布（根据需求调整）

      # -------------------------- 6. 上传 bin 到 Release Assets --------------------------
      - name: Upload Bin to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}  # 来自创建 Release 的输出
          asset_path: ATC_Thermometer.bin  # 本地 bin 文件路径
          asset_name: ${{ steps.verify_bin.outputs.bin_name }}  # Release 中显示的文件名
          content_type: application/octet-stream  # 二进制文件类型
