name: release

on:
  push:
    tags:
      - "v*"  # 匹配语义化版本标签（如 1.0.0、2.1.3）

permissions:
  contents: write  # 允许修改仓库内容（创建/编辑 Release）

jobs:
  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Get the release version from the tag
        if: env.VERSION == ''
        run: echo "VERSION=${{ github.ref_name }}" | tee -a $GITHUB_ENV

      - name: Install jq (for parsing GH CLI output)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create GitHub release (draft)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${VERSION}" --draft --verify-tag --title "$VERSION" --json upload_url > release_output.json
          echo "UPLOAD_URL=$(jq -r '.upload_url' release_output.json)" >> $GITHUB_OUTPUT  # 输出 upload_url 供后续步骤使用

    outputs:
      version: ${{ env.VERSION }}
      upload_url: ${{ steps.create_release.outputs.UPLOAD_URL }}  # 暴露 upload_url 给依赖的 Job

  build:
    name: Build & Upload Bin
    needs: [create_release]  # 依赖 create_release Job，获取 upload_url
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            make

      - name: Build project with Make
        run: make  # 执行编译，生成 ATC_Thermometer.bin

      - name: Verify Bin File
        id: verify_bin
        run: |
          if [[ ! -f "ATC_Thermometer.bin" ]]; then
            echo "::error::ATC_Thermometer.bin not found in root directory!"
            exit 1
          fi
          echo "✅ Bin file found: $(pwd)/ATC_Thermometer.bin"
          echo "bin_name=ATC_Thermometer.bin" >> $GITHUB_OUTPUT  # 输出 bin 文件名

      - name: Upload Bin to Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.upload_url }}  # 从 create_release 获取上传地址
          asset_path: ${{ steps.verify_bin.outputs.bin_name }}  # 本地 bin 文件路径
          asset_name: ${{ steps.verify_bin.outputs.bin_name }}  # Release 中显示的文件名
          content_type: application/octet-stream  # 二进制文件类型

    outputs:
      version: ${{ needs.create_release.outputs.version }}  # 传递版本号给后续 Job

  publish_release:
    name: Publish Release
    needs: [build]  # 依赖 build Job，确保 bin 已上传
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Get the release version from the tag
        if: env.VERSION == ''
        run: echo "VERSION=${{ github.ref_name }}" | tee -a $GITHUB_ENV

      - name: Publish GitHub release (un-draft)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release edit "${VERSION}" --draft=false  # 将草稿 Release 改为正式发布
